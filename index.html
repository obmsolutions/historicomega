<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ANALISADOR QUADRANTE MEGA</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; margin: 10px; }
    th, td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
        width: 50px;
        height: 50px;
        font-size: 14px;
        position: relative;
    }
    #table1 { border: 2px solid black; margin-bottom: 20px; }
    #table2 { margin-top: 20px; }
    /* Quadrantes */
    #table1 tr:nth-child(3) td,
    #table1 tr:nth-child(6) td { border-bottom: 3px solid black; }
    #table1 td:nth-child(5),
    #table1 td:nth-child(10) { border-right: 3px solid black; }
    .btn {
        margin: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        min-height: 44px;
    }
    .btn:hover { background-color: #0056b3; }
    .btn-secondary {
        background-color: #6c757d;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    .color-segment {
        height: 100%;
        width: 100%;
        display: inline-block;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }
    .cell-number {
        position: relative;
        z-index: 2;
        color: black;
        font-weight: bold;
    }
    .legend {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        border-radius: 5px;
        display: inline-block;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border: 1px solid #000;
    }
    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px 0;
        align-items: center;
    }
    #rotate-warning {
        display: none;
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid #ffeeba;
    }
    .search-container {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .search-input {
        padding: 10px;
        width: 120px;
        margin-right: 10px;
    }
    .search-result {
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 5px;
        display: none;
    }
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="rotate-warning">
    <p>Para melhor visualização, gire seu dispositivo para o modo paisagem.</p>
</div>

<h1>ANALISADOR QUADRANTE MEGA</h1>

<!-- Busca de concurso -->
<div class="search-container">
    <h3>Buscar Concurso Oficial</h3>
    <input type="number" id="concursoInput" class="search-input" placeholder="Número do concurso" min="1" />
    <button class="btn btn-secondary" id="searchButton">Buscar</button>
    <div id="loadingIndicator" style="display:none;"><span class="loading"></span> Buscando resultados...</div>
    <div id="searchResult" class="search-result"></div>
</div>

<!-- Tabela 1 -->
<table id="table1">
    <tbody></tbody>
</table>

<!-- Tabela 2 -->
<table id="table2">
    <thead>
        <tr>
            <th>N° Concurso</th>
            <th>Dez 01</th>
            <th>Dez 02</th>
            <th>Dez 03</th>
            <th>Dez 04</th>
            <th>Dez 05</th>
            <th>Dez 06</th>
        </tr>
    </thead>
    <tbody>
        <!-- 10 Linhas para os últimos 10 jogos -->
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
    </tbody>
</table>

<!-- Botões -->
<div class="button-container">
    <button class="btn" id="clearButton">Limpar</button>
    <button class="btn" id="analyzeButton">Apuração</button>
</div>

<!-- Legenda -->
<div id="legendContainer" class="legend"></div>

<script>
    // Criar tabela1 quadrantes
    const tbody1 = document.querySelector("#table1 tbody");
    let num = 1;
    for(let r=0; r<6; r++){
        const tr = document.createElement("tr");
        for(let c=0; c<10; c++){
            const td = document.createElement("td");
            td.textContent = String(num).padStart(2, "0");
            td.dataset.value = num;
            tr.appendChild(td);
            num++;
        }
        tbody1.appendChild(tr);
    }

    // Limpar tabela1 cores e legenda
    function clearTable1Colors(){
        const cells = document.querySelectorAll("#table1 td");
        cells.forEach(cell => {
            cell.style.background = "";
            cell.innerHTML = `<span class="cell-number">${String(cell.dataset.value).padStart(2,"0")}</span>`;
        });
        document.getElementById("legendContainer").innerHTML = "";
    }

    // Limpar tabela2
    function clearTable2(){
        const rows = document.querySelectorAll("#table2 tbody tr");
        rows.forEach(row => {
            for(let cell of row.cells){
                cell.textContent = "";
            }
        });
    }

    document.getElementById("clearButton").addEventListener("click", () => {
        clearTable2();
        clearTable1Colors();
        document.getElementById("searchResult").style.display = "none";
    });

    // Apuração: colore tabela1 conforme tabela2 e cria legenda
    document.getElementById("analyzeButton").addEventListener("click", () => {
        clearTable1Colors();

        const colors = ["red", "orange", "yellow", "lightblue", "purple", "green", "pink", "blue", "brown", "gray"];
        const table2rows = document.querySelectorAll("#table2 tbody tr");
        const numberOccurrences = {};

        table2rows.forEach((row, i) => {
            const cells = row.querySelectorAll("td");
            cells.forEach((cell, idx) => {
                if(idx > 0 && cell.textContent.trim()){
                    const val = parseInt(cell.textContent.trim());
                    if(!numberOccurrences[val]) numberOccurrences[val] = [];
                    numberOccurrences[val].push(i);
                }
            });
        });

        const table1cells = document.querySelectorAll("#table1 td");
        table1cells.forEach(cell => {
            const val = parseInt(cell.dataset.value);
            if(numberOccurrences[val]){
                const uniqueColors = [...new Set(numberOccurrences[val].map(i => colors[i]))];
                const count = uniqueColors.length;
                cell.innerHTML = `<span class="cell-number">${String(val).padStart(2,"0")}</span>`;
                uniqueColors.forEach((color, idx) => {
                    const seg = document.createElement("div");
                    seg.className = "color-segment";
                    seg.style.backgroundColor = color;
                    seg.style.width = `${100/count}%`;
                    seg.style.left = `${(100/count)*idx}%`;
                    cell.appendChild(seg);
                });
            }
        });

        // legenda
        const legend = document.getElementById("legendContainer");
        legend.innerHTML = "";
        table2rows.forEach((row, i) => {
            const cnum = row.cells[0].textContent.trim();
            if(cnum){
                const item = document.createElement("div");
                item.className = "legend-item";
                item.innerHTML = `<div class="legend-color" style="background-color: ${colors[i]}"></div> Concurso ${cnum}`;
                legend.appendChild(item);
            }
        });
    });

    // Aviso orientação dispositivo
    function checkOrientation(){
        const warn = document.getElementById("rotate-warning");
        warn.style.display = (window.innerHeight > window.innerWidth) ? "block" : "none";
    }
    window.addEventListener("resize", checkOrientation);
    checkOrientation();

    // Busca concurso (botão Buscar)
    document.getElementById("searchButton").addEventListener("click", async () => {
        const concurso = parseInt(document.getElementById("concursoInput").value);
        const loading = document.getElementById("loadingIndicator");
        const searchResult = document.getElementById("searchResult");

        if(!concurso || concurso <= 0){
            searchResult.style.display = "block";
            searchResult.textContent = "Informe um número válido de concurso.";
            return;
        }

        loading.style.display = "inline-block";
        searchResult.style.display = "none";
        clearTable1Colors();

        try {
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://servicebus2.caixa.gov.br/portaldeloterias/api/megasena/${concurso}`)}`;
            const response = await fetch(url);
            if(!response.ok) throw new Error("Erro ao buscar o concurso.");

            const data = await response.json();
            const result = JSON.parse(data.contents);

            if(result.error) throw new Error(result.error);

            searchResult.style.display = "block";
            searchResult.innerHTML = `
                <p><strong>Concurso ${result.numero}</strong> - ${new Date(result.dataApuracao).toLocaleDateString()}</p>
                <p>Dezenas sorteadas: ${result.listaDezenas.join(", ")}</p>
                <button class="btn" id="addToTableBtn" style="margin-top:10px;">Adicionar à Tabela</button>
            `;

            document.getElementById("addToTableBtn").addEventListener("click", () => {
                addWithPrevious(concurso);
            });
        } catch (e) {
            searchResult.style.display = "block";
            searchResult.textContent = "Erro: " + e.message;
        } finally {
            loading.style.display = "none";
        }
    });

    // Função para adicionar concurso atual + últimos 9 anteriores à tabela 2
    async function addWithPrevious(startConcurso){
        const loading = document.getElementById("loadingIndicator");
        loading.style.display = "inline-block";

        const table2rows = document.querySelectorAll("#table2 tbody tr");
        clearTable2();

        try {
            let addedCount = 0;
            for(let c = startConcurso; c > startConcurso - 10; c--){
                if(c <= 0) break;

                const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://servicebus2.caixa.gov.br/portaldeloterias/api/megasena/${c}`)}`;
                const resp = await fetch(url);
                if(!resp.ok) continue;

                const data = await resp.json();
                const res = JSON.parse(data.contents);
                if(res.error || !res.listaDezenas || res.listaDezenas.length < 6) continue;

                if(addedCount >= table2rows.length) break;
                const row = table2rows[addedCount];
                row.cells[0].textContent = res.numero;
                for(let i=0; i<6; i++){
                    row.cells[i+1].textContent = res.listaDezenas[i];
                }
                addedCount++;
            }
        } catch(e){
            alert("Erro ao adicionar concursos anteriores: " + e.message);
        } finally {
            loading.style.display = "none";
        }
    }
</script>

</body>
</html>